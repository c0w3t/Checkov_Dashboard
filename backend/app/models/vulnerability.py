"""
Vulnerability Model
"""
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Text, Enum as SQLEnum
from sqlalchemy.orm import relationship
from datetime import datetime
from app.database import Base
import enum

class SeverityLevel(str, enum.Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"

class VulnerabilityStatus(str, enum.Enum):
    OPEN = "open"
    IN_PROGRESS = "in_progress"
    RESOLVED = "resolved"
    IGNORED = "ignored"

class Vulnerability(Base):
    __tablename__ = "vulnerabilities"

    id = Column(Integer, primary_key=True, index=True)
    scan_id = Column(Integer, ForeignKey("scans.id"), nullable=False, index=True)
    
    # Vulnerability details
    check_id = Column(String(100), nullable=False, index=True)
    check_name = Column(String(500), nullable=False)
    severity = Column(
        SQLEnum(
            SeverityLevel,
            native_enum=True,
            name="severitylevel",
            create_type=False,
            values_callable=lambda enum_cls: [e.value for e in enum_cls],
            validate_strings=True,
        ),
        nullable=False,
        index=True,
    )
    status = Column(
        SQLEnum(
            VulnerabilityStatus,
            native_enum=True,
            name="vulnerabilitystatus",
            create_type=False,
            values_callable=lambda enum_cls: [e.value for e in enum_cls],
            validate_strings=True,
        ),
        default=VulnerabilityStatus.OPEN,
        index=True,
    )
    
    # Location information
    file_path = Column(String(1000), nullable=False)
    resource_type = Column(String(100), nullable=True)
    resource_name = Column(String(255), nullable=True)
    line_number = Column(Integer, nullable=True)  # Main line number
    line_start = Column(Integer, nullable=True)
    line_end = Column(Integer, nullable=True)
    
    # Description and remediation
    description = Column(Text, nullable=True)
    remediation = Column(Text, nullable=True)
    guideline_url = Column(String(500), nullable=True)
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    detected_at = Column(DateTime, default=datetime.utcnow)  # First time this vulnerability was detected
    last_seen_at = Column(DateTime, default=datetime.utcnow)  # Last scan where this vulnerability appeared
    resolved_at = Column(DateTime, nullable=True)  # When the vulnerability was fixed

    # Fix tracking
    resolution_scan_id = Column(Integer, ForeignKey("scans.id"), nullable=True, index=True)  # Scan that confirmed the fix
    vulnerability_hash = Column(String(64), nullable=True, index=True)  # Hash to identify same vulnerability across scans

    # Relationships
    scan = relationship("Scan", back_populates="vulnerabilities", foreign_keys=[scan_id])
    resolution_scan = relationship("Scan", foreign_keys=[resolution_scan_id])
