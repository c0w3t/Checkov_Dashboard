import React from 'react';
import { Card, CardContent, Typography, Box } from '@mui/material';
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts';

interface VulnerabilityByProjectProps {
  data: Array<{
    project_name: string;
    failed_checks: number;
  }>;
}

const COLORS = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140'];

const VulnerabilityByProject: React.FC<VulnerabilityByProjectProps> = ({ data }) => {
  const totalVulnerabilities = data.reduce((sum, item) => sum + item.failed_checks, 0);
  
  const chartData = data
    .filter(item => item.failed_checks > 0)
    .map(item => ({
      name: item.project_name,
      value: item.failed_checks,
      percentage: ((item.failed_checks / totalVulnerabilities) * 100).toFixed(1)
    }))
    .sort((a, b) => b.value - a.value);



  return (
    <Card sx={{ 
      height: '100%',
      background: '#ffffff',
      boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
      borderRadius: 2,
      border: '1px solid #e2e8f0',
      transition: 'all 0.2s ease',
      '&:hover': {
        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
      }
    }}>
      <CardContent sx={{ p: 2 }}>
        <Box sx={{ mb: 2 }}>
          <Typography 
            variant="h6" 
            sx={{ 
              fontWeight: 700,
              fontSize: '1.125rem',
              color: '#1a202c',
              mb: 0.5,
              letterSpacing: '-0.3px'
            }}
          >
            Vulnerabilities by Project
          </Typography>
          <Typography variant="body2" sx={{ color: '#718096', fontSize: '0.875rem' }}>
            Distribution of issues across projects
          </Typography>
        </Box>
        {chartData.length === 0 ? (
          <Box
            sx={{
              height: 300,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              color: 'text.secondary',
            }}
          >
            <Box
              sx={{
                width: 80,
                height: 80,
                borderRadius: '50%',
                background: 'linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                mb: 2,
              }}
            >
              <Typography variant="h3" sx={{ fontSize: '2.5rem' }}>ðŸ“Š</Typography>
            </Box>
            <Typography variant="body1" sx={{ fontWeight: 600, color: '#2d3748' }}>No vulnerabilities found</Typography>
            <Typography variant="body2" sx={{ color: 'text.secondary', mt: 0.5 }}>All projects are secure</Typography>
          </Box>
        ) : (
          <ResponsiveContainer width="100%" height={240}>
            <PieChart>
              <Pie
                data={chartData}
                cx="50%"
                cy="50%"
                labelLine={false}
                outerRadius={85}
                innerRadius={55}
                fill="#8884d8"
                dataKey="value"
                paddingAngle={2}
                strokeWidth={0}
              >
                {chartData.map((_, index) => (
                  <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                ))}
              </Pie>
              <Tooltip
                content={({ active, payload }) => {
                  if (active && payload && payload.length) {
                    const data = payload[0].payload;
                    return (
                      <Box
                        sx={{
                          backgroundColor: '#ffffff',
                          border: '1px solid #e2e8f0',
                          borderRadius: '8px',
                          boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                          p: 1.5,
                        }}
                      >
                        <Typography variant="body2" sx={{ fontWeight: 600, color: '#2d3748', mb: 0.5 }}>
                          {data.name}
                        </Typography>
                        <Typography variant="body2" sx={{ color: '#718096', fontSize: '0.85rem' }}>
                          {data.value} issues ({data.percentage}%)
                        </Typography>
                      </Box>
                    );
                  }
                  return null;
                }}
              />
              <Legend 
                wrapperStyle={{
                  paddingTop: '10px',
                  fontSize: '13px'
                }}
                iconType="circle"
                iconSize={8}
                formatter={(value, _: any) => {
                  const data = chartData.find(d => d.name === value);
                  return (
                    <span style={{ color: '#4a5568', fontSize: '13px', fontWeight: 500 }}>
                      {value}: {data?.value}
                    </span>
                  );
                }}
              />
            </PieChart>
          </ResponsiveContainer>
        )}
      </CardContent>
    </Card>
  );
};

export default VulnerabilityByProject;
