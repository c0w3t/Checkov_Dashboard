import React, { useState } from 'react';
import {
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Chip,
  IconButton,
  TextField,
  MenuItem,
  Box,
  Collapse
} from '@mui/material';
import { ExpandMore, ExpandLess, AutoFixHigh } from '@mui/icons-material';
import { Button } from '@mui/material';
import { Vulnerability } from '../../types';
import AIFixSuggester from '../AIFixSuggester';
import FileVersionHistory from '../FileVersionHistory';

interface VulnerabilityListProps {
  vulnerabilities: Vulnerability[];
}

const getSeverityColor = (severity: string) => {
  switch (severity) {
    case 'critical':
      return 'error';
    case 'high':
      return 'warning';
    case 'medium':
      return 'info';
    case 'low':
      return 'success';
    default:
      return 'default';
  }
};

const VulnerabilityList: React.FC<VulnerabilityListProps> = ({ vulnerabilities }) => {
  const [filter, setFilter] = useState({ severity: 'all', status: 'all' });
  const [expandedRows, setExpandedRows] = useState<Set<number>>(new Set());
  const [aiFixOpen, setAiFixOpen] = useState(false);
  const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null);
  const [historyOpen, setHistoryOpen] = useState(false);
  const [historyUploadId, setHistoryUploadId] = useState<string>('');
  const [historyRelPath, setHistoryRelPath] = useState<string>('');

  const filteredVulnerabilities = vulnerabilities.filter((vuln) => {
    if (filter.severity !== 'all' && vuln.severity !== filter.severity) return false;
    if (filter.status !== 'all' && vuln.status !== filter.status) return false;
    return true;
  });

  const toggleRow = (id: number) => {
    const newExpanded = new Set(expandedRows);
    if (newExpanded.has(id)) {
      newExpanded.delete(id);
    } else {
      newExpanded.add(id);
    }
    setExpandedRows(newExpanded);
  };

  const openAIFix = (vuln: Vulnerability) => {
    setSelectedVuln(vuln);
    setAiFixOpen(true);
  };

  const openHistory = (vuln: Vulnerability) => {
    const parts = vuln.file_path.split('/');
    const idx = parts.indexOf('uploads');
    if (idx >= 0 && parts.length > idx + 2) {
      const uploadId = `${parts[idx+1]}/${parts[idx+2]}`;
      const rel = parts.slice(idx+3).join('/') || parts[parts.length-1];
      setHistoryUploadId(uploadId);
      setHistoryRelPath(rel);
    } else {
      setHistoryUploadId(`project_${vuln.scan_id || 'unknown'}`);
      const name = parts[parts.length-1];
      setHistoryRelPath(name);
    }
    setHistoryOpen(true);
  };

  return (
    <Box>
      <Box display="flex" gap={2} mb={2}>
        <TextField
          select
          label="Severity"
          value={filter.severity}
          onChange={(e) => setFilter({ ...filter, severity: e.target.value })}
          size="small"
          sx={{ minWidth: 150 }}
        >
          <MenuItem value="all">All Severities</MenuItem>
          <MenuItem value="critical">Critical</MenuItem>
          <MenuItem value="high">High</MenuItem>
          <MenuItem value="medium">Medium</MenuItem>
          <MenuItem value="low">Low</MenuItem>
          <MenuItem value="info">Info</MenuItem>
        </TextField>

        <TextField
          select
          label="Status"
          value={filter.status}
          onChange={(e) => setFilter({ ...filter, status: e.target.value })}
          size="small"
          sx={{ minWidth: 150 }}
        >
          <MenuItem value="all">All Statuses</MenuItem>
          <MenuItem value="open">Open</MenuItem>
          <MenuItem value="in_progress">In Progress</MenuItem>
          <MenuItem value="resolved">Resolved</MenuItem>
          <MenuItem value="ignored">Ignored</MenuItem>
        </TextField>
      </Box>

      <TableContainer component={Paper}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell width={50}></TableCell>
              <TableCell>Check ID</TableCell>
              <TableCell>Check Name</TableCell>
              <TableCell>Severity</TableCell>
              <TableCell>Status</TableCell>
              <TableCell>File</TableCell>
              <TableCell>Line</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {filteredVulnerabilities.map((vuln) => (
              <React.Fragment key={vuln.id}>
                <TableRow>
                  <TableCell>
                    <IconButton size="small" onClick={() => toggleRow(vuln.id)}>
                      {expandedRows.has(vuln.id) ? <ExpandLess /> : <ExpandMore />}
                    </IconButton>
                  </TableCell>
                  <TableCell>{vuln.check_id}</TableCell>
                  <TableCell>{vuln.check_name}</TableCell>
                  <TableCell>
                    <Chip
                      label={vuln.severity.toUpperCase()}
                      color={getSeverityColor(vuln.severity) as any}
                      size="small"
                    />
                  </TableCell>
                  <TableCell>
                    <Chip label={vuln.status} size="small" />
                  </TableCell>
                  <TableCell>{vuln.file_path}</TableCell>
                  <TableCell>
                    {vuln.line_start ? `${vuln.line_start}-${vuln.line_end}` : 'N/A'}
                  </TableCell>
                </TableRow>
                <TableRow>
                  <TableCell style={{ paddingBottom: 0, paddingTop: 0 }} colSpan={7}>
                    <Collapse in={expandedRows.has(vuln.id)} timeout="auto" unmountOnExit>
                      <Box margin={2}>
                        <Box display="flex" justifyContent="flex-end" mb={1}>
                          <Chip
                            label={vuln.severity.toUpperCase()}
                            color={getSeverityColor(vuln.severity) as any}
                            size="small"
                            sx={{ mr: 1 }}
                          />
                          <IconButton
                            size="small"
                            color="secondary"
                            onClick={() => openAIFix(vuln)}
                            aria-label="AI Suggest Fix"
                          >
                            <AutoFixHigh />
                          </IconButton>
                          <Button size="small" onClick={() => openHistory(vuln)} sx={{ ml: 1 }}>
                            History
                          </Button>
                        </Box>
                        <Box mb={2}>
                          <strong>Description:</strong>
                          <Box 
                            component="pre" 
                            sx={{ 
                              mt: 1,
                              p: 2, 
                              bgcolor: 'grey.100', 
                              borderRadius: 1,
                              overflow: 'auto',
                              fontSize: '0.875rem',
                              whiteSpace: 'pre-wrap',
                              fontFamily: 'monospace'
                            }}
                          >
                            {vuln.description || 'No description available'}
                          </Box>
                        </Box>
                        {vuln.remediation && (
                          <Box mb={2}>
                            <strong>Remediation:</strong>
                            <Box 
                              component="pre" 
                              sx={{ 
                                mt: 1,
                                p: 2, 
                                bgcolor: 'grey.100', 
                                borderRadius: 1,
                                overflow: 'auto',
                                fontSize: '0.875rem',
                                whiteSpace: 'pre-wrap',
                                fontFamily: 'monospace'
                              }}
                            >
                              {vuln.remediation}
                            </Box>
                          </Box>
                        )}
                        {vuln.guideline_url && (
                          <Box>
                            <strong>Guideline:</strong>{' '}
                            <a href={vuln.guideline_url} target="_blank" rel="noopener noreferrer">
                              {vuln.guideline_url}
                            </a>
                          </Box>
                        )}
                      </Box>
                    </Collapse>
                  </TableCell>
                </TableRow>
              </React.Fragment>
            ))}
          </TableBody>
        </Table>
      </TableContainer>
      <AIFixSuggester
        open={aiFixOpen}
        onClose={() => setAiFixOpen(false)}
        vulnerability={selectedVuln ? {
          id: selectedVuln.id,
          check_id: selectedVuln.check_id,
          check_name: selectedVuln.check_name,
          severity: selectedVuln.severity,
          description: selectedVuln.description || '',
          resource_type: selectedVuln.resource_type,
          file_path: selectedVuln.file_path,
        } : {
          id: 0,
          check_id: '',
          check_name: '',
          severity: 'info',
          description: '',
          resource_type: '',
          file_path: ''
        }}
      />
      <FileVersionHistory
        open={historyOpen}
        onClose={() => setHistoryOpen(false)}
        uploadId={historyUploadId}
        filePath={historyRelPath}
        vulnerabilityId={selectedVuln?.id}
      />
    </Box>
  );
};

export default VulnerabilityList;
